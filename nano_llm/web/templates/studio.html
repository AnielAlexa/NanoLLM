<!doctype html>

<html>
	<head>
    <meta charset="utf-8">
    <title>{{ title }}</title>

    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
    
    <link rel="stylesheet" href="/static/bootstrap.css">
    <link rel="stylesheet" href="/static/select2.min.css">
    <link rel="stylesheet" href="/static/chat.css">
    
    <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack-all.min.js"></script>
    <script type='text/javascript' src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
    
    <script type='text/javascript' src="/static/jquery-3.6.3.min.js"></script>
    <script type='text/javascript' src='/static/bootstrap.bundle.min.js'></script>
    <script type='text/javascript' src="/static/select2.min.js"></script>
    <script type='text/javascript' src='/static/webrtc.js'></script>
    <script type='text/javascript' src='/static/websocket.js'></script>
    <script type='text/javascript' src='/static/debounce.js'></script>
    <script type='text/javascript' src='/static/audio.js'></script>
    <script type='text/javascript' src='/static/grid.js'></script>
    
    <script type="text/javascript">

      function onWebsocketMsg(payload, type) {
        if( type == MESSAGE_JSON ) {     
          if( 'modules' in payload ) {
            addModules(payload['modules']);
          }
          
          if( 'plugin_types' in payload ) {
            addPluginTypes(payload['plugin_types']);
          }
          
          if( 'plugin_added' in payload ) {
            addPlugins(payload['plugin_added']);
          }
          
          if( 'send_output' in payload ) {
            sendOutput(payload['send_output']);
          }
          
          if( 'state_dict' in payload ) {
            setStateDict(payload['state_dict']);
          }
          
          if( 'stats' in payload ) {
            setStats(payload['stats']);
          }
          
          if( 'alert' in payload ) {
            addAlert(payload['alert']);
          }
        }
        else if( type == MESSAGE_AUDIO ) {
          onAudioOutput(payload);
        }
      }
      
      function onTestDialogSubmit() {
        console.log('onTestDialogSubmit()');
      }
      
      window.onload = function() {

        connectWebsocket(onWebsocketMsg, port={{ ws_port }});
        
        enumerateAudioDevices();
        openAudioDevices();

        //window.setInterval(generateAudio, 100);
        //window.setInterval(testWebsocketSend, 500);
        addGrid();

      }
      </script>
      <style>
          #alert_container {
            z-index: 100;
            position: fixed;
            max-width: max-content;
            height:50px;
            left:100%;
            transform:translateX(-100%);
            top:85px;
          }

          .gear-button {
            color: #888888;
            font-size: 150%;
          }
          
          .gear-button:hover {
            color: #cccccc;
          }
          
          .select2-container--default .select2-selection--multiple, .select2-results {
            color: #222222;
            scrollbar-color: #AAAAAA #EEEEEE;
          }
          
          .select2-container--default .select2-selection--single {
            height: 120%;
            line-height: 120%;
            vertical-align : middle;
          }
          
          .select2-selection__arrow {
            padding-top: 35px;
            padding-right: 25px;
          }
          
          .select2-selection__rendered {
            padding-top: 3px;
          }
          
          .select2-search__field {
            color: #222222;
            background-color: #EEEEEE;
          }
      
          @media (min-width: 768px) {
            .modal-dialog {
              width: 90%;
              max-width:600px;
            }
          
            .modal-xl {
              width: 90%;
              max-width:1200px;
            }
          }

          
          /*.grid-stack-item {
            background-color: #1FAD32;
          }*/
      </style>

	</head>
	<!-- bg-medium-gray -->
	<body class="bg-dark-gray" data-bs-theme="dark" height="100%">
    <!-- Navbar + main body -->
    <div class="d-flex flex-column">
      <nav class="navbar navbar-expand-lg navbar-dark bg-sage-green p-0"> <!-- fixed-top will let rest of body scroll -->
        <div class="container-fluid p-2">
          <div class="d-flex flex-grow-1">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarToggler" aria-controls="navbarToggler" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand ms-2" href="#">
                <div class="mb-0 h4" style="font-family: monospace, monospace;">
                    <img src="static/nvidia_logo_white_65.png" style="max-height: 35px"></img>
                    {{title}}
                </div>
            </a>
            <span class="w-100 d-lg-none d-block">
              <!-- hidden spacer to center brand on mobile --></span>
          </div>
          <div class="collapse navbar-collapse flex-grow-1 text-right" id="navbarToggler">
            <ul class="navbar-nav ms-auto flex-nowrap"> <!-- me-auto mb-2 mb-lg-0 -->
              <!--<li class="nav-item">
                <a class="nav-link" href="#">Agent</a>
              </li>-->
              <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#test_dialog">Agent</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#audioDialog">Audio</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarChatHistory" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Chat
                </a>
                <ul class="dropdown-menu" aria-labelledby="navbarChatHistory">
                  <li><a class="dropdown-item" href="#" id="chat_length">0 / 4096 tokens</a></li>
                  <li><a class="dropdown-item" href="#" onclick="onChatHistoryReset()">Reset Chat</a></li>
                  <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profileDialog">User Profile</a>
                  <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#displayDialog">Display Options</a>
                </ul>
              </li>
            </ul>
          </div>
          <span class="navbar-nav ms-auto me-0 flex-row align-items-center">
            <button id="audio-input-mute" class="btn btn-primary btn-circle btn-md bi bi-mic-mute-fill ms-1 me-1" type="button" title="Mute/unmute the microphone" onclick="muteAudioInput()"></button>
            <button id="audio-output-mute" class="btn btn-primary btn-circle btn-md bi bi-volume-up-fill me-1" type="button" title="Mute/unmute the speakers" onclick="muteAudioOutput()"></button>
            <span id="Tegrastats_node_stats" class="ms-1 px-2 py-1" style="background-color: rgba(0,0,0,0.2); font-size: 75%; font-family: monospace, monospace;"></span>
          </span>
        </div>
      </nav>
    </div>
              
    <div class="grid-stack m-2"></div>
    
    <!-- Audio settings dialog -->
    <div class="modal fade" id="audioDialog" tabindex="-1" aria-labelledby="audioDialogLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="audioDialogLabel">Audio Settings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="color: #eeeeee;"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="audio-input-select" class="form-label">Input Device (Microphone)</label>
              <select id="audio-input-select" name="audio-input-select" class="form-select" onclick="openAudioDevices()"></select>
            </div>
            <div class="mb-3">
              <label for="audio-output-select" class="form-label">Output Device (Speaker)</label>
              <select id="audio-output-select" name="audio-output-select" class="form-select" onclick="openAudioDevices()"></select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <!--<button type="button" class="btn btn-primary">Save changes</button>-->
          </div>
        </div>
      </div>
    </div>

    
    <!-- Alert Messages -->
    <div id="alert_container" class="container"> <!--class="fixed-top"-->
      <div id="alert_window" class="alert mb-0" style="background-color: rgba(48,48,48,1.0); display: none">
        <div id="alert_messages" class="me-3"></div>
        <a href="#" class="btn-close" style="position: absolute; right: 5px; top: 5px; font-size: 80%" onclick="onHideAlerts()"></a>
      </div>
      
      <script type='text/javascript'>
        function alertColor(level) {
          if( level == 'success' ) return 'limegreen';
          else if( level == 'error' ) return 'orange';
          else if( level == 'warning' ) return 'orange';
          else return 'rgb(200,200,200)';
        
        }
        function toTimeString(timestamp) {
          return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', hour12: true, minute: '2-digit', second: '2-digit' }).slice(0,-3); // remove AM/PM
        }
          
        function onHideAlerts() {
          $('#alert_window').fadeOut('slow', function() {
            $(`#alert_messages pre`).remove();
          });
        }
        
        function removeAlert(id) {
          $(`#alert_messages #alert-${id}`).remove();
        }
        
        function addAlert(alert) {
          // supress other messages from the same category that may still be showing
          if( alert['category'].length > 0 )
            $(`#alert_messages .alert-category-${alert['category']}`).remove();
            
          // add a new element containing the alert message, and show the window if needed
          $('#alert_messages').append(`<pre id="alert-${alert['id']}" class="align-middle m-0 alert-category-${alert['category']}" style="color: ${alertColor(alert['level'])}">[${alert['time']}] ${alert['message']}\n</pre>`);
          $('#alert_window:hidden').fadeIn('fast');

          // automatically remove the messages (if this is the last message, hide the window too)
          if( alert['timeout'] > 0 ) {
            const alert_id = alert['id'];
            setTimeout(function() {
              if( $('#alert_messages pre').length > 1 ) {
                $(`#alert_messages #alert-${alert_id}`).remove();
                console.log('removing alerts due to timeout');
                console.log(`#alert_messages #alert-${alert_id}`);
              }
              else if( $(`#alert_messages #alert-${alert['id']}`).length > 0 ) {
                onHideAlerts();
              }
            }, alert['timeout']);
          }
        }
      </script>
    </div>

    <link rel="stylesheet" href="/static/drawflow.css">
    
	</body>
</html>
